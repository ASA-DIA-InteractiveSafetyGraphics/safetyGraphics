---
title: "safetyGraphics Shiny App - Adding Charts"
author: "Jeremy Wildfire"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{safetyGraphics Shiny App - User Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overview
safetyGraphics is designed to serve as a flexible and extensible platform for analyzing clinical trial safety. This vignette shows how users can easily add custom charts to the safetyGraphics shiny app.

As of the v1.1 release, safetyGraphics supports 4 types of charts - Static charts, Plotly charts, Shiny Modules and HTML widgets. Behind the scenes, all 4 chart types have two major technical components: **code** and **metadata**. As such, making a custom chart requires the user to create an R script that defines the chart's code and metadata. The examples below describe the step-by-step process for creating a chart.

# Creating a Custom Chart - Step-by-Step

There are 4 steps required to create a custom chart for use in `safetyGraphics`:

1. Create custom chart code
2. Add new settings to the app (if needed)
3. Add the chart to the app
4. Initialize the app

Let's look at these steps in more detail.

## Step 1 - Create custom chart code

The first, and most complicated, step is to write the code for the custom chart. All common charting packages are supported including `ggplot2`, `lattice` and base R graphics. As a trivial example, here is the code for a simple bar chart that counts number of observations present for each type of lab measurement collected.

```
countLabs<- function(data, settings){
  counts <- table(data[[setting$measure_col]])
  barplot(counts, main=settings$barChartTitle)
}
```

Let's work through the different pieces of this custom chart. First and foremost, notice that the code to create the chart is wrapped in a function that takes 2 parameters as inputs: `data` and `settings`. When the chart function is called by Shiny, these parameters are generated dynamically within the app; `data` represents the user selection in the Data module, and `settings` represents the selections in the Settings Module.

The `data` parameter is saved as a `data.frame`, and a preview of the current data is conveniently available in the data tab.  The `settings` parameter is saved as a `list` and is slightly more complex. Each setting shown on the settings page has a unique ID (called a `text_key` in the package) that gives its position in the settings `list`. In our example, the "Measure column" setting has the ID `measure_col` and is accessed in the charting function via `settings$measure_col`. Additional technical documentation about the `settings` list is provided in Appendix 1.

Note that line 2 in the function above references the measure column dynamically by combining `data` and `settings` like so: `data[[setting$measure_col]]`. This pattern, as opposed of directly specifying a column name like `data$PARAM`, allows the chart to work with any data standard. The important pattern is used repeatedly across all `safetyGraphics` charts.

Line 3 of our sample function draws the bar chart using the counts created with the `table()` statement in line 2. Line 3 also introduces a custom setting - `settings$barChartTitle` - so that the user can provide a custom title for the chart in the shiny app if desired. All custom settings must be initialized using the `addSetting()` function; this process is described in Step 2 below.

Finally, note that the process for defining custom "htmlwidget" and "shiny module" charts is slightly different than the sample code above; examples 2 and 3 below provide basic examples of those chart types.

## Step 2 - Add custom settings to the App

Next, we'll add any new settings to the app using the `addSetting()` function.  For our example above, we would add the `participant_label` setting as follows:

```
addSetting(
  text_key="barChartTitle",
  label="Bar Chart Title",
  description="Title for the Lab Count Bar Chart",
  setting_type="character",
  setting_cat="appearance",
  default="Lab Count",
  settingsLocation=getwd()
)
```

Repeat as needed for multiple settings. For full details about each parameter see `?addSetting`.

Finally, note that if all of the settings used by your chart are already defined, you can skip this step. The full list of predefined settings can be found in the `safetyGraphics::settingsMetadata` dataset included with the package.

## Step 3 - Add the chart to the App

Next, we need to add the chart itself to the app using `addChart()`. We'd add the example above as follows:

```
addChart(
  chart="count_labs", #all lower case
  main="countLabs",  #the name of your function created in step 1
  label="Count Labs - Demo",
  settingsLocation = getwd(),
  requiredSettings=c("measure_col","barChartTitle"),
  type="static"
)
```

For full details about each parameter see `?addChart`.

## Step 4 - Initialize the app

Finally, we need to initialize the app using the updates we've made in the steps above. The easiest way to wrap up the code from Steps 1, 2 and 3 in a custom R script, then reference that script in a call to `safetyGraphicsApp()` (see Appendix 3 for the full script ready to copy/paste). For example, if you save your custom script as `/customChart/mySettings.R` then you would use the following to initialize the app:

```
safetyGraphicsApp(
  settingsLocation="/customChart",
  customSettings="mySettings.R"
)
```

As expected, you see our new "Bar Chart Title" setting under the settings tab. Let's change that option from the default value:

<img width="470" alt="Screen Shot 2019-10-23 at 7 08 30 AM" src="https://user-images.githubusercontent.com/3680095/67382751-631eac00-f564-11e9-8f98-883f57ecf1a6.png">

And here is our sweet new custom chart:

![image](https://user-images.githubusercontent.com/3680095/67382917-a37e2a00-f564-11e9-9eb0-3060cff121d5.png)

It looks like we've got the same number of observations for all labs in our sample data.

Three additional examples of this process are provided below. The appendices describe the technical framework in more detail and explains how to update the underlying metadata files to add a new default chart type to the application.

# Example 1 - Custom Static Graphic

Now let's create a custom chart that shows the distribution of lab values with a simple Box plot using `ggplot2`. The charting function is shown below, and the full script with `addSetting()` and `addChart()` is saved in Appendix 3:

```
labdist<-function(data,settings){
  mapped_data <- data %>%
    select(Value = settings[["value_col"]], Measure = settings[["measure_col"]])%>%
    filter(!is.na(Value))

  ggplot(data = mapped_data, aes(x = Measure, y = Value)) +
    geom_boxplot(fill = settings[["boxcolor"]]) +
    scale_y_log10() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 25, hjust = 1),
          axis.text = element_text(size = 12),
          axis.title = element_text(size = 12))
}
```

And here's the chart:

![](https://user-images.githubusercontent.com/14199771/67016263-eacc6c80-f0c5-11e9-9f03-9cc1f12a5a1d.png)

This example expands on the initial barplot example in the following ways:
- The path of the chart script is saved as `custom_location` at the top of the script and re-used throughout.
- The custom script is saved as "/customBoxplot/customSettings.R".  Which simplifies calling the app to: `safetyGraphicsApp(settingsLocation="/customBoxplot")` since "customSettings.R" is the default value for the `customSettings` parameter.
- The `labdist()` charting function performs some simple data manipulation to prepare the data for the plot (see the derivation of `mapped_data`. Because our settings object is generated dynamically, it is often helpful to convert these dynamic text strings into consistent names to be used in downstream charting functions that use non-standard evaluation.

# Example 2 - Custom Shiny Module

We can expand on our static boxplot from Example 1 by adding some interactivity.  Placing our boxplot in a Shiny module will allow the user to make chart-specific aesthetic adjustments on the fly.  In this example, we've added the ability to add/remove individual data points, transform the y-axis scale, and show/hide outliers:

![](https://user-images.githubusercontent.com/14199771/67016434-2ff09e80-f0c6-11e9-892b-94e57438ca9a.png)

This example expands on the static boxplot example in the following ways:
- Most of the underlying code for manipulating the dataset and creating the `ggplot2` figure is identical to the static boxplot example. However, we've added some conditional statements to modify the boxplot based on the user selections.
- Instead of a single chart function, we now have two: the module UI function, and the module server function. The UI function has the same name as the server function, with `_UI` appended. These functions should be specified (our sourced from an external file) within customSettings.R.
- `data` and `settings` are passed to the module server function as reactive objects.

The full code for the custom script is saved in appendix 3.

# Example 3 - Custom htmlwidget

Custom `htmlwidgets` are not currently supported via `addChart()` and addSetting()`, but we plan to add support in future release.

For now, please contact the package development team or [file an issue on GitHub](https://github.com/SafetyGraphics/safetyGraphics/issues) if you would like to add a custom `htmlwidget` to safetyGraphics, and we can discuss technical details.  

# Appendix 1 - Settings Framework Technical Details

This appendix provides a detailed technical description of the settings framework used in the application. As described in the [introductory vignette](https://github.com/SafetyGraphics/safetyGraphics/wiki/Vignette:-Shiny-User-Guide#update-settings), the settings Shiny module allows users to make a [wide](https://github.com/SafetyGraphics/safetyGraphics/wiki/Vignette:-Shiny-User-Guide#case-study-1---mapping-non-standard-data) [range](https://github.com/SafetyGraphics/safetyGraphics/wiki/Vignette:-Shiny-User-Guide#case-study-2---adding-customizations) of customizations to the charts for any given study. Understanding the underlying technical details of this settings customization process is perhaps the most complicated aspect of designing custom charts for `safetyGraphics`. This appendix is broken in to 2 sections, the first describes the structure of the settings themselves, the second describes the metadata used to generate the settings when the package is built.

## Settings Structure

Behind the scenes, the settings are stored as a `list`, which is updated in real time as the user makes changes in the Shiny settings module. A small chunk of a typical settings `list` is shown below. Note that this was generated using `generateSettings(standard="adam")`. More details on this and other functions related to settings is provided below.

![image](https://user-images.githubusercontent.com/3680095/67284859-ca792500-f4ac-11e9-9c70-fc0565447b7b.png)

As described in the examples above, the current settings `list` is passed directly to the chart function whenever a user views a chart in the shiny app. Each control in the settings module is tied to a single component in the setting `list` using a unique key, which that unique key defines setting's position in the list. You can see the unique key for any setting, by hovering over the title for the control in the shiny app. As an example, the "ID column" control has a unique key of "id_col", which is accessible in the settings `list` via `settings$id_col`, which would resolve to "USUBJID", the default value for the ADaM data standard, in our sample settings above. The settings framework also supports nested settings. A double dash "--" indicates a level of nesting in the `list`, so a setting ID of "measure_values--ALT" would be accessed as `settings[["measure_values"]][["ALT"]]`, which would resolve to "Alanine Aminotransferase (U/L)" in our sample settings.

You can see additional details about pre-loaded settings by viewing the safetyGraphics::settingsMetadata data file that contains the default settings for the shiny app. ?settingsMetadata provides detailed data specifications for the metadata file, which also match the options available in the addSetting() function used in the examples above.

The `safetyGraphics` pacakge includes several functions specifically designed for use with settings objects. As mentioned above, you can generate a default settings list for a data standard using the `generateSettings()` function:

```
safetyGraphics::generateSettings()  # no standard
safetyGraphics::generateSettings(standard="ADaM") # ADaM standard
```

Other functions for working with settings (all used liberally by the shiny app) include: `getRequiredSettings()`, `generateShell()`, `getSettingKeys()`, `getSettingValue()`, `getSettingsMetadata()`, `setSettingsValue()`, `trimSettings()` and `validateSettings()`. The R documentation for each of these functions provides technical details and examples for common use cases. Note also that all of the charts included with the application have detailed standalone documentation referenced in the `repo_url` and `settings_url` fields found in the `chartsMetadata` file; for example, the `hep-explorer`'s configuration page is [here](https://github.com/SafetyGraphics/hep-explorer/wiki/Configuration) and provides a lot of additional context about how each setting is used by the chart.

Finally, note that for htmlwidgets the settings `list` is converted to a json object with the following code:

```
settings_list <- list(...)
jsonlite::toJSON(
      settings_list,
      auto_unbox = TRUE,
      null = "null"
    )
```

## Metadata framework

In general, there are 3 primary types of metadata used in the shiny app: chart metadata, setting metadata and data standard metadata. The metadata files that provide key information to the Shiny app and allow for the app to automatically be updated with new charts, settings, and standards.

The underlying technical framework for the metadata is somewhat complex. In general, we follow the recommendations from the [Data chapter](http://r-pkgs.had.co.nz/data.html) in Hadley Wickham's R Packages book. Using that workflow, we combine 5 "raw" metadata files (saved in `data-raw\`) in to 3 data files that are available as part of the package (saved in `data\` with documentation in `R\`). An R script to convert the 5 "raw" files to the 3 files in the package is saved as `data-raw\csv-to-rda.raw`, which is re-run whenever the metadata framework is updated.

The `addChart()` and  `addSetting()` functions (and their evil twins `removeCharts()` and `removeSettings()`) allow users to customize these metadata files without actually rebuilding the entire package. These functions simply edit, add or remove rows from the `settingsMetadata` and `chartsMetadata` files saved in `data\` and then save local copies of the files that are used in place of the default versions. This customization is likely enough for most users, but developers looking to make permanent changes to the apps default must go a level deeper and edit the files saved in `data-raw/`. More detail about those raw files is provided below, and step-by-step instructions for creating a new default chart are provided in Appendix 2.

- **Charts metadata (chartsMetadata.csv)**: This file informs the Shiny app about all of the chart modules that should be made available to the user. The structure of this file is 1 row per chart. Columns contain chart-specific details such as chart name, type, and size.

- **Settings Metadata for Charts (settingsMetadataCharts.csv)**: This file helps the Shiny app understand which settings are needed for the different charts. This information is incorporated in the Settings configuration and Reporting modules. The structure of this file is 1 row per unique setting and 1 column per chart.  `TRUE`/`FALSE` values are used to indicate whether the setting is relevant to a given chart.

- **Settings Metadata (settingsMetadata.csv)**:  This file informs the Shiny app about all of the possible settings across all of the charts.  Specifically, the file helps to populate the Settings tab of the app, and it also ensures that settings are successfully handed off to the charts. The structure is 1 row per setting and the columns contain information such as a description of the setting, type of setting (e.g. data mapping), and whether the setting is optional or required.  

- **Settings Defaults (generateSettingsMetadataDefaults.R)**: Ths file contains information about the default values for the settings (specifically for non-data mapping settings).  A `.R` file is used in place of a `.csv` to preserve the R value type (numeric, string, list, etc) of the defaults. While all settings are represented (structure of 1 row per setting), all data mapping defaults should be set to `NULL` and handled in the Standards metadata file.

- **Standards metadata (standardsMetadata.csv)**: This file contains information about the default values for the settings for each data standard (specifically for data mapping settings). The file helps the Shiny app automatically detect data standards in uploaded files, and automate settings configuration if the data is in a standard format. The structure of the file is 1 row per setting and 1 column per data standard. While all settings are represented, all rows corresponding to non-data mapping settings should be left blank.

# Appendix 2 - Step-by-Step Process for Contributing a New a Default Chart to safetyGraphics Package

1. Make a new branch of the safetyGraphics master [repository](https://github.com/SafetyGraphics/safetyGraphics).

2. Create a new charting function using the guidelines in the examples above

3. Drop the file containing the charting function in the `inst/custom` directory, under the subfolder that matches the chart type (static, plotly, or Shiny module).

4. Update metadata
   - Update metadata files:
      - For all custom charts:
         - Add a row for the new chart to `data-raw/chartsMetadata.csv`
         - Add a column for the new chart to `data-raw/settingsMetadataCharts.csv`.
      - For charts that contain new settings:
         - Add rows for new settings to `data-raw/settingsMetadata.csv`
         - Add defaults for new settings in `data-raw/generateSettingsMetadataDefaults.R` and re-run the file.
         - Add rows for new settings in `data-raw/settingsMetadataCharts.csv`.
         - Add rows for new settings in the data standard mappings in `data_raw/standardsMetaData.csv`
   - Run `data-raw/csv_to_rda.R` to save the files to `data/`.
   - Add chart to documentation file for settingsMetadata: `R/settingsMetadata.R`. Append `chart_` to the name of your chart function/file and add it as an item in the list.

5. Update package dependencies.
If you've added a plotly chart:
   - Add plotly to DESCRIPTION file Imports
   - Add `library(plotly)` to top of `global.R` file under `inst/safetyGraphics_app`

6. Update package documentation with `devtools::document()`.  

7. Rebuild the R package, test out the Shiny app, and make a PR to the safetyGraphics repo.
# Appendix 3 - Full Custom Scripts for Examples

## Full Code for Step-by-Step walkthrough

```
#####################################################################
# Step 1 - Write custom chart code
#####################################################################
countLabs<- function(data, settings){
  counts <- table(data[[setting$measure_col]])
  barplot(counts, main=settings$barChartTitle)
}

#####################################################################
# Step 2 - Initialize Custom Settings
#####################################################################
addSetting(
  text_key="barChartTitle",
  label="Bar Chart Title",
  description="Title for the Lab Count Bar Chart",
  setting_type="character",
  setting_cat="appearance",
  default="Lab Count",
  settingsLocation=getwd()
)

#####################################################################
# Step 3 - Initialize the custom chart
#####################################################################
addChart(
  chart="count_labs", #all lower case
  main="countLabs",  #the name of your function created in step 1
  label="Count Labs - Demo",
  settingsLocation = getwd(),
  requiredSettings=c("measure_col","barChartTitle"),
  type="static"
)

# To initialize the chart run:
# safetyGraphicsApp(
#  settingsLocation="/customChart",
#  customSettings="mySettings.R"
#)

```

## Full Code for Example 1

```
custom_location<-"customBoxplot/"

#####################################################################
# Step 1 - Write custom chart code
#####################################################################
labdist<-function(data,settings){
  mapped_data <- data %>%
    select(Value = settings[["value_col"]], Measure = settings[["measure_col"]])%>%
    filter(!is.na(Value))

  ggplot(data = mapped_data, aes(x = Measure, y = Value)) +
    geom_boxplot(fill = settings[["boxcolor"]]) +
    scale_y_log10() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 25, hjust = 1),
          axis.text = element_text(size = 12),
          axis.title = element_text(size = 12))
}

#####################################################################
# Step 2 - Initialize Custom Settings
#####################################################################
addSetting(
  text_key="boxcolor",
  label="Box Plot Color",
  description="The color of the boxes",
  setting_type="character",
  setting_cat="appearance",
  default="gray",
  settingsLocation=custom_location
)


#####################################################################
# Step 3 - Initialize the custom chart
#####################################################################
addChart(
  chart="labdist",
  main="labdist",
  label="Lab Distribution - static",
  settingsLocation = custom_location,
  requiredSettings=c("boxcolor","value_col","measure_col"),
  type="static"
)

#To call the app run:
#safetyGraphicsApp(settingsLocation="/customBoxplot")

```

## Full Code for Example 2

```
custom_location<-"customBoxplot/"

#####################################################################
# Step 1 - Write custom chart module code
#####################################################################
labdist_module_UI <- function(id) {
  ns <- NS(id)
  tagList(
    checkboxInput(ns("show_points"), "Show points?", value=FALSE),
    checkboxInput(ns("show_outliers"), "Show outliers?", value=TRUE),
    selectInput(ns("scale"), "Scale Transform", choices=c("Log-10","None")),
    plotOutput(ns("labdist"), width = "1000px")
  )
}

labdist_module <- function(input, output, session, data, settings) {

  ns <- session$ns

  mapped_data <- reactive({
    data() %>%
      select(Value = settings()[["value_col"]],
             Measure = settings()[["measure_col"]])%>%
      filter(!is.na(Value))
  })

  output$labdist <- renderPlot({

    req(mapped_data())

    # set up the plot
    p <- ggplot(data = mapped_data(), aes(x = Measure, y = Value)) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 25, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size = 12))

    # add/remove outliers
    if (input$show_outliers){
      p <- p + geom_boxplot(fill = settings()[["boxcolor"]])
    } else {
      p <- p + geom_boxplot(fill = settings()[["boxcolor"]], outlier.shape = NA)
    }

    # log-transform scale
    if (input$scale=="Log-10"){
      p <- p + scale_y_log10()
    }

    # show individual data points
    if (input$show_points){
      p <- p + geom_jitter(width = 0.2)
    }  

    p
  })
}

#####################################################################
# Step 2 - Initialize Custom Settings
#####################################################################
addSetting(
  text_key="boxcolor",
  label="Box Plot Color",
  description="The color of the boxes",
  setting_type="character",
  setting_cat="appearance",
  default="gray",
  settingsLocation=custom_location
)

#####################################################################
# Step 3 - Initialize the custom chart
#####################################################################
addChart(
  chart="labdist_module",
  main="labdist_module",
  label="Lab Distribution - shiny module",
  settingsLocation = custom_location,
  requiredSettings=c("boxcolor","value_col","measure_col"),
  type="module"
)
```
